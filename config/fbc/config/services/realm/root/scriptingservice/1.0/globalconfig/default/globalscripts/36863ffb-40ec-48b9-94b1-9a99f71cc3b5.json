{
  "metadata" : {
    "realm" : null,
    "entityType" : "ScriptingService",
    "entityId" : "default/globalScripts/36863ffb-40ec-48b9-94b1-9a99f71cc3b5",
    "uid" : "ou=36863ffb-40ec-48b9-94b1-9a99f71cc3b5,ou=globalScripts,ou=default,ou=GlobalConfig,ou=1.0,ou=ScriptingService,ou=services,ou=am-config",
    "sunServiceID" : "globalScript",
    "objectClass" : [
      "top",
      "sunServiceComponent"
    ],
    "pathParams" : { },
    "ou" : [
      "36863ffb-40ec-48b9-94b1-9a99f71cc3b5"
    ]
  },
  "data" : {
    "_id" : "default/globalScripts/36863ffb-40ec-48b9-94b1-9a99f71cc3b5",
    "_type" : {
      "_id" : "ScriptingService",
      "name" : "ScriptingService",
      "collection" : false
    },
    "createdBy" : "null",
    "lastModifiedDate" : "0",
    "lastModifiedBy" : "null",
    "name" : "OIDC Claims Script",
    "context" : "OIDC_CLAIMS",
    "description" : "Default global script for OIDC claims",
    "language" : "GROOVY",
    "creationDate" : "0",
    "script" : "LyoKICogQ29weXJpZ2h0IDIwMTQtMjAxOSBGb3JnZVJvY2sgQVMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQKICoKICogVXNlIG9mIHRoaXMgY29kZSByZXF1aXJlcyBhIGNvbW1lcmNpYWwgc29mdHdhcmUgbGljZW5zZSB3aXRoIEZvcmdlUm9jayBBUy4KICogb3Igd2l0aCBvbmUgb2YgaXRzIGFmZmlsaWF0ZXMuIEFsbCB1c2Ugc2hhbGwgYmUgZXhjbHVzaXZlbHkgc3ViamVjdAogKiB0byBzdWNoIGxpY2Vuc2UgYmV0d2VlbiB0aGUgbGljZW5zZWUgYW5kIEZvcmdlUm9jayBBUy4KICovCmltcG9ydCBjb20uaXBsYW5ldC5zc28uU1NPRXhjZXB0aW9uCmltcG9ydCBjb20uc3VuLmlkZW50aXR5LmlkbS5JZFJlcG9FeGNlcHRpb24KaW1wb3J0IG9yZy5mb3JnZXJvY2sub2F1dGgyLmNvcmUuZXhjZXB0aW9ucy5JbnZhbGlkUmVxdWVzdEV4Y2VwdGlvbgppbXBvcnQgb3JnLmZvcmdlcm9jay5vYXV0aDIuY29yZS5Vc2VySW5mb0NsYWltcwppbXBvcnQgb3JnLmZvcmdlcm9jay5vcGVuaWRjb25uZWN0LkNsYWltCgovKgoqIERlZmluZWQgdmFyaWFibGVzOgoqIGxvZ2dlciAtIGFsd2F5cyBwcmVzZW50cywgdGhlICJPQXV0aDJQcm92aWRlciIgZGVidWcgbG9nZ2VyIGluc3RhbmNlCiogY2xhaW1zIC0gYWx3YXlzIHByZXNlbnQsIGRlZmF1bHQgc2VydmVyIHByb3ZpZGVkIGNsYWltcyAtIE1hcDxTdHJpbmcsIE9iamVjdD4KKiBjbGFpbU9iamVjdHMgLSBhbHdheXMgcHJlc2VudCwgZGVmYXVsdCBzZXJ2ZXIgcHJvdmlkZWQgY2xhaW1zIC0gTGlzdDxDbGFpbT4KKiBzZXNzaW9uIC0gcHJlc2VudCBpZiB0aGUgcmVxdWVzdCBjb250YWlucyB0aGUgc2Vzc2lvbiBjb29raWUsIHRoZSB1c2VyJ3Mgc2Vzc2lvbiBvYmplY3QKKiBpZGVudGl0eSAtIGFsd2F5cyBwcmVzZW50LCB0aGUgaWRlbnRpdHkgb2YgdGhlIHJlc291cmNlIG93bmVyCiogc2NvcGVzIC0gYWx3YXlzIHByZXNlbnQsIHRoZSByZXF1ZXN0ZWQgc2NvcGVzCiogcmVxdWVzdGVkQ2xhaW1zIC0gTWFwPFN0cmluZywgU2V0PFN0cmluZz4+CiogICAgICAgICAgICAgICAgICBhbHdheXMgcHJlc2VudCwgbm90IGVtcHR5IGlmIHRoZSByZXF1ZXN0IGNvbnRhaW5zIGEgY2xhaW1zIHBhcmFtZXRlciBhbmQgc2VydmVyIGhhcyBlbmFibGVkCiogICAgICAgICAgICAgICAgICBjbGFpbXNfcGFyYW1ldGVyX3N1cHBvcnRlZCwgbWFwIG9mIHJlcXVlc3RlZCBjbGFpbXMgdG8gcG9zc2libGUgdmFsdWVzLCBvdGhlcndpc2UgZW1wdHksCiogICAgICAgICAgICAgICAgICByZXF1ZXN0ZWQgY2xhaW1zIHdpdGggbm8gcmVxdWVzdGVkIHZhbHVlcyB3aWxsIGhhdmUgYSBrZXkgYnV0IG5vIHZhbHVlIGluIHRoZSBtYXAuIEEga2V5IHdpdGgKKiAgICAgICAgICAgICAgICAgIGEgc2luZ2xlIHZhbHVlIGluIGl0cyBTZXQgaW5kaWNhdGVzIHRoaXMgaXMgdGhlIG9ubHkgdmFsdWUgdGhhdCBzaG91bGQgYmUgcmV0dXJuZWQuCiogcmVxdWVzdGVkVHlwZWRDbGFpbXMgLSBMaXN0PENsYWltPgoqICAgICAgICAgICAgICAgICAgICAgICBhbHdheXMgcHJlc2VudCwgbm90IGVtcHR5IGlmIHRoZSByZXF1ZXN0IGNvbnRhaW5zIGEgY2xhaW1zIHBhcmFtZXRlciBhbmQgc2VydmVyIGhhcyBlbmFibGVkCiogICAgICAgICAgICAgICAgICAgICAgIGNsYWltc19wYXJhbWF0ZXJfc3VwcG9ydGVkLCBsaXN0IG9mIHJlcXVlc3RlZCBjbGFpbXMgd2l0aCBjbGFpbSBuYW1lLCByZXF1ZXN0ZWQgcG9zc2libGUgdmFsdWVzCiogICAgICAgICAgICAgICAgICAgICAgIGFuZCBpZiBjbGFpbSBpcyBlc3NlbnRpYWwsIG90aGVyd2lzZSBlbXB0eSwKKiAgICAgICAgICAgICAgICAgICAgICAgcmVxdWVzdGVkIGNsYWltcyB3aXRoIG5vIHJlcXVlc3RlZCB2YWx1ZXMgd2lsbCBoYXZlIGEgY2xhaW0gd2l0aCBubyB2YWx1ZXMuIEEgY2xhaW1zIHdpdGgKKiAgICAgICAgICAgICAgICAgICAgICAgYSBzaW5nbGUgdmFsdWUgaW5kaWNhdGVzIHRoaXMgaXMgdGhlIG9ubHkgdmFsdWUgdGhhdCBzaG91bGQgYmUgcmV0dXJuZWQuCiogY2xhaW1zTG9jYWxlcyAtIHRoZSB2YWx1ZXMgZnJvbSB0aGUgJ2NsYWltc19sb2NhbGVzJyBwYXJhbWV0ZXIgLSBMaXN0PFN0cmluZz4KKiBSZXF1aXJlZCB0byByZXR1cm4gYSBNYXAgb2YgY2xhaW1zIHRvIGJlIGFkZGVkIHRvIHRoZSBpZF90b2tlbiBjbGFpbXMKKgoqIEV4cGVjdGVkIHJldHVybiB2YWx1ZSBzdHJ1Y3R1cmU6CiogVXNlckluZm9DbGFpbXMgewoqICAgIE1hcDxTdHJpbmcsIE9iamVjdD4gdmFsdWVzOyAvLyBUaGUgdmFsdWVzIG9mIHRoZSBjbGFpbXMgZm9yIHRoZSB1c2VyIGluZm9ybWF0aW9uCiogICAgTWFwPFN0cmluZywgTGlzdDxTdHJpbmc+PiBjb21wb3NpdGVTY29wZXM7IC8vIE1hcHBpbmcgb2Ygc2NvcGUgbmFtZSB0byBhIGxpc3Qgb2YgY2xhaW0gbmFtZXMuCiogfQoqLwoKLy8gdXNlciBzZXNzaW9uIG5vdCBndWFyYW50ZWVkIHRvIGJlIHByZXNlbnQKYm9vbGVhbiBzZXNzaW9uUHJlc2VudCA9IHNlc3Npb24gIT0gbnVsbAoKbG9nZ2VyLndhcm5pbmcoIlJFUVVFU1Q6ICRyZXF1ZXN0UHJvcGVydGllcyIpOwpyZXF1ZXN0ZWRUeXBlZENsYWltcy5lYWNoIHsgY2xhaW0gLT4KICBsb2dnZXIud2FybmluZygicmVxdWVzdGVkVHlwZWRDbGFpbTogJGNsYWltIik7Cn0KCi8qCiAqIFB1bGxzIGZpcnN0IHZhbHVlIGZyb20gdXNlcnMgcHJvZmlsZSBhdHRyaWJ1dGUKICoKICogQHBhcmFtIGNsYWltIFRoZSBjbGFpbSBvYmplY3QuCiAqIEBwYXJhbSBhdHRyIFRoZSBwcm9maWxlIGF0dHJpYnV0ZSBuYW1lLgogKi8KZGVmIGZyb21TZXQgPSB7IGNsYWltLCBhdHRyIC0+CiAgICBpZiAoYXR0ciAhPSBudWxsICYmIGF0dHIuc2l6ZSgpID09IDEpewogICAgICAgIGF0dHIuaXRlcmF0b3IoKS5uZXh0KCkKICAgIH0gZWxzZSBpZiAoYXR0ciAhPSBudWxsICYmIGF0dHIuc2l6ZSgpID4gMSl7CiAgICAgICAgYXR0cgogICAgfSBlbHNlIGlmIChsb2dnZXIud2FybmluZ0VuYWJsZWQoKSkgewogICAgICAgIGxvZ2dlci53YXJuaW5nKCJPcGVuQU1TY29wZVZhbGlkYXRvci5nZXRVc2VySW5mbygpOiBHb3QgYW4gZW1wdHkgcmVzdWx0IGZvciBjbGFpbT0kY2xhaW0iKTsKICAgIH0KfQoKLy8gLS0tdnZ2dnZ2dnZ2di0tLSBFWEFNUExFIENMQUlNIEFUVFJJQlVURSBSRVNPTFZFUiBGVU5DVElPTlMgLS0tdnZ2dnZ2dnZ2di0tLQovKgogKiBDbGFpbSByZXNvbHZlciB3aGljaCByZXNvbHZlcyB0aGUgdmFsdWUgb2YgdGhlIGNsYWltIGZyb20gaXRzIHJlcXVlc3RlZCB2YWx1ZXMuCiAqCiAqIFRoaXMgcmVzb2x2ZXIgd2lsbCByZXR1cm4gYSB2YWx1ZSBpZiB0aGUgY2xhaW0gaGFzIG9uZSByZXF1ZXN0ZWQgdmFsdWVzLCBvdGhlcndpc2UgYW4gZXhjZXB0aW9uIGlzIHRocm93bi4KICovCmRlZmF1bHRDbGFpbVJlc29sdmVyID0geyBjbGFpbSAtPgogICAgaWYgKGNsYWltLmdldFZhbHVlcygpLnNpemUoKSA9PSAxKSB7CiAgICAgICAgWyhjbGFpbS5nZXROYW1lKCkpOiBjbGFpbS5nZXRWYWx1ZXMoKS5pdGVyYXRvcigpLm5leHQoKV0KICAgIH0gZWxzZSB7CiAgICAgICAgWzpdCiAgICB9Cn0KCi8qCiAqIENsYWltIHJlc29sdmVyIHdoaWNoIHJlc29sdmVzIHRoZSB2YWx1ZSBvZiB0aGUgY2xhaW0gYnkgbG9va2luZyB1cCB0aGUgdXNlcidzIHByb2ZpbGUuCiAqCiAqIFRoaXMgcmVzb2x2ZXIgd2lsbCByZXR1cm4gYSB2YWx1ZSBmb3IgdGhlIGNsYWltIGlmOgogKiAjIHRoZSB1c2VyJ3MgcHJvZmlsZSBhdHRyaWJ1dGUgaXMgbm90IG51bGwKICogIyBBTkQgdGhlIGNsYWltIGNvbnRhaW5zIG5vIHJlcXVlc3RlZCB2YWx1ZXMKICogIyBPUiB0aGUgY2xhaW0gY29udGFpbnMgcmVxdWVzdGVkIHZhbHVlcyBhbmQgdGhlIHZhbHVlIGZyb20gdGhlIHVzZXIncyBwcm9maWxlIGlzIGluIHRoZSBsaXN0IG9mIHZhbHVlcwogKgogKiBJZiBubyBtYXRjaCBpcyBmb3VuZCBhbiBleGNlcHRpb24gaXMgdGhyb3duLgogKi8KdXNlclByb2ZpbGVDbGFpbVJlc29sdmVyID0geyBhdHRyaWJ1dGUsIGNsYWltLCBpZGVudGl0eSAtPgogICAgaWYgKGlkZW50aXR5ICE9IG51bGwpIHsKICAgICAgICB1c2VyUHJvZmlsZVZhbHVlID0gZnJvbVNldChjbGFpbS5nZXROYW1lKCksIGlkZW50aXR5LmdldEF0dHJpYnV0ZShhdHRyaWJ1dGUpKQogICAgICAgIGlmICh1c2VyUHJvZmlsZVZhbHVlICE9IG51bGwgJiYgKGNsYWltLmdldFZhbHVlcygpID09IG51bGwgfHwgY2xhaW0uZ2V0VmFsdWVzKCkuaXNFbXB0eSgpIHx8IGNsYWltLmdldFZhbHVlcygpLmNvbnRhaW5zKHVzZXJQcm9maWxlVmFsdWUpKSkgewogICAgICAgICAgICByZXR1cm4gWyhjbGFpbS5nZXROYW1lKCkpOiB1c2VyUHJvZmlsZVZhbHVlXQogICAgICAgIH0KICAgIH0KICAgIFs6XQp9CgovKgogKiBDbGFpbSByZXNvbHZlciB3aGljaCByZXNvbHZlcyB0aGUgdmFsdWUgb2YgdGhlIGNsYWltIG9mIHRoZSB1c2VyJ3MgYWRkcmVzcy4KICoKICogVGhpcyByZXNvbHZlciB3aWxsIHJldHVybiBhIHZhbHVlIGZvciB0aGUgY2xhaW0gaWY6CiAqICMgdGhlIHZhbHVlIG9mIHRoZSBhZGRyZXNzIGlzIG5vdCBudWxsCiAqCiAqLwp1c2VyQWRkcmVzc0NsYWltUmVzb2x2ZXIgPSB7IGNsYWltLCBpZGVudGl0eSAtPgogICAgaWYgKGlkZW50aXR5ICE9IG51bGwpIHsKICAgICAgICBhZGRyZXNzRm9ybWF0dGVkVmFsdWUgPSBmcm9tU2V0KGNsYWltLmdldE5hbWUoKSwgaWRlbnRpdHkuZ2V0QXR0cmlidXRlKCJwb3N0YWxhZGRyZXNzIikpCiAgICAgICAgaWYgKGFkZHJlc3NGb3JtYXR0ZWRWYWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICAgICAgImZvcm1hdHRlZCIgOiBhZGRyZXNzRm9ybWF0dGVkVmFsdWUKICAgICAgICAgICAgXQogICAgICAgIH0KICAgIH0KICAgIFs6XQp9CgovKgogKiBDbGFpbSByZXNvbHZlciB3aGljaCByZXNvbHZlcyB0aGUgdmFsdWUgb2YgdGhlIGNsYWltIGJ5IGxvb2tpbmcgdXAgdGhlIHVzZXIncyBwcm9maWxlLgogKgogKiBUaGlzIHJlc29sdmVyIHdpbGwgcmV0dXJuIGEgdmFsdWUgZm9yIHRoZSBjbGFpbSBpZjoKICogIyB0aGUgdXNlcidzIHByb2ZpbGUgYXR0cmlidXRlIGlzIG5vdCBudWxsCiAqICMgQU5EIHRoZSBjbGFpbSBjb250YWlucyBubyByZXF1ZXN0ZWQgdmFsdWVzCiAqICMgT1IgdGhlIGNsYWltIGNvbnRhaW5zIHJlcXVlc3RlZCB2YWx1ZXMgYW5kIHRoZSB2YWx1ZSBmcm9tIHRoZSB1c2VyJ3MgcHJvZmlsZSBpcyBpbiB0aGUgbGlzdCBvZiB2YWx1ZXMKICoKICogSWYgdGhlIGNsYWltIGlzIGVzc2VudGlhbCBhbmQgbm8gdmFsdWUgaXMgZm91bmQgYW4gSW52YWxpZFJlcXVlc3RFeGNlcHRpb24gd2lsbCBiZSB0aHJvd24gYW5kIHJldHVybmVkIHRvIHRoZSB1c2VyLgogKiBJZiBubyBtYXRjaCBpcyBmb3VuZCBhbiBleGNlcHRpb24gaXMgdGhyb3duLgogKi8KZXNzZW50aWFsQ2xhaW1SZXNvbHZlciA9IHsgYXR0cmlidXRlLCBjbGFpbSwgaWRlbnRpdHkgLT4KICAgIGlmIChpZGVudGl0eSAhPSBudWxsKSB7CiAgICAgICAgdXNlclByb2ZpbGVWYWx1ZSA9IGZyb21TZXQoY2xhaW0uZ2V0TmFtZSgpLCBpZGVudGl0eS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlKSkKICAgICAgICBpZiAoY2xhaW0uaXNFc3NlbnRpYWwoKSAmJiAodXNlclByb2ZpbGVWYWx1ZSA9PSBudWxsIHx8IHVzZXJQcm9maWxlVmFsdWUuaXNFbXB0eSgpKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZFJlcXVlc3RFeGNlcHRpb24oIkNvdWxkIG5vdCBwcm92aWRlIHZhbHVlIGZvciBlc3NlbnRpYWwgY2xhaW0gJGNsYWltIikKICAgICAgICB9CiAgICAgICAgaWYgKHVzZXJQcm9maWxlVmFsdWUgIT0gbnVsbCAmJiAoY2xhaW0uZ2V0VmFsdWVzKCkgPT0gbnVsbCB8fCBjbGFpbS5nZXRWYWx1ZXMoKS5pc0VtcHR5KCkgfHwgY2xhaW0uZ2V0VmFsdWVzKCkuY29udGFpbnModXNlclByb2ZpbGVWYWx1ZSkpKSB7CiAgICAgICAgICAgIHJldHVybiBbKGNsYWltLmdldE5hbWUoKSk6IHVzZXJQcm9maWxlVmFsdWVdCiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIFs6XQp9CgovKgogKiBDbGFpbSByZXNvbHZlciB3aGljaCBleHBlY3RzIHRoZSB1c2VyJ3MgcHJvZmlsZSBhdHRyaWJ1dGUgdmFsdWUgdG8gYmUgaW4gdGhlIGZvbGxvd2luZyBmb3JtYXQ6CiAqICJsYW5ndWFnZV90YWd8dmFsdWVfZm9yX2xhbmd1YWdlLC4uLiIuCiAqCiAqIFRoaXMgcmVzb2x2ZXIgd2lsbCB0YWtlIHRoZSBsaXN0IG9mIHJlcXVlc3RlZCBsYW5ndWFnZXMgZnJvbSB0aGUgJ2NsYWltc19sb2NhbGVzJyBhdXRob3JpemUgcmVxdWVzdAogKiBwYXJhbWV0ZXIgYW5kIGF0dGVtcHQgdG8gbWF0Y2ggaXQgdG8gYSB2YWx1ZSBmcm9tIHRoZSB1c2VycycgcHJvZmlsZSBhdHRyaWJ1dGUuCiAqIElmIG5vIG1hdGNoIGlzIGZvdW5kIGFuIGV4Y2VwdGlvbiBpcyB0aHJvd24uCiAqLwpjbGFpbUxvY2FsZXNDbGFpbVJlc29sdmVyID0geyBhdHRyaWJ1dGUsIGNsYWltLCBpZGVudGl0eSAtPgogICAgaWYgKGlkZW50aXR5ICE9IG51bGwpIHsKICAgICAgICB1c2VyUHJvZmlsZVZhbHVlID0gZnJvbVNldChjbGFpbS5nZXROYW1lKCksIGlkZW50aXR5LmdldEF0dHJpYnV0ZShhdHRyaWJ1dGUpKQogICAgICAgIGlmICh1c2VyUHJvZmlsZVZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgbG9jYWxlVmFsdWVzID0gcGFyc2VMb2NhbGVBd2FyZVN0cmluZyh1c2VyUHJvZmlsZVZhbHVlKQogICAgICAgICAgICBsb2NhbGUgPSBjbGFpbXNMb2NhbGVzLmZpbmQgeyBsb2NhbGUgLT4gbG9jYWxlVmFsdWVzLmNvbnRhaW5zS2V5KGxvY2FsZSkgfQogICAgICAgICAgICBpZiAobG9jYWxlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBbKGNsYWltLmdldE5hbWUoKSk6IGxvY2FsZVZhbHVlcy5nZXQobG9jYWxlKV0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHJldHVybiBbOl0KfQoKLyoKICogQ2xhaW0gcmVzb2x2ZXIgd2hpY2ggZXhwZWN0cyB0aGUgdXNlcidzIHByb2ZpbGUgYXR0cmlidXRlIHZhbHVlIHRvIGJlIGluIHRoZSBmb2xsb3dpbmcgZm9ybWF0OgogKiAibGFuZ3VhZ2VfdGFnfHZhbHVlX2Zvcl9sYW5ndWFnZSwuLi4iLgogKgogKiBUaGlzIHJlc29sdmVyIHdpbGwgdGFrZSB0aGUgbGFuZ3VhZ2UgdGFnIHNwZWNpZmllZCBpbiB0aGUgY2xhaW0gb2JqZWN0IGFuZCBhdHRlbXB0IHRvIG1hdGNoIGl0IHRvIGEgdmFsdWUKICogZnJvbSB0aGUgdXNlcnMnIHByb2ZpbGUgYXR0cmlidXRlLiBJZiBubyBtYXRjaCBpcyBmb3VuZCBhbiBleGNlcHRpb24gaXMgdGhyb3duLgogKi8KbGFuZ3VhZ2VUYWdDbGFpbVJlc29sdmVyID0geyBhdHRyaWJ1dGUsIGNsYWltLCBpZGVudGl0eSAtPgogICAgaWYgKGlkZW50aXR5ICE9IG51bGwpIHsKICAgICAgICB1c2VyUHJvZmlsZVZhbHVlID0gZnJvbVNldChjbGFpbS5nZXROYW1lKCksIGlkZW50aXR5LmdldEF0dHJpYnV0ZShhdHRyaWJ1dGUpKQogICAgICAgIGlmICh1c2VyUHJvZmlsZVZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgbG9jYWxlVmFsdWVzID0gcGFyc2VMb2NhbGVBd2FyZVN0cmluZyh1c2VyUHJvZmlsZVZhbHVlKQogICAgICAgICAgICBpZiAoY2xhaW0uZ2V0TG9jYWxlKCkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKGxvY2FsZVZhbHVlcy5jb250YWluc0tleShjbGFpbS5nZXRMb2NhbGUoKSkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gWyhjbGFpbS5nZXROYW1lKCkpOiBsb2NhbGVWYWx1ZXMuZ2V0KGNsYWltLmdldExvY2FsZSgpKV0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZW50cnkgPSBsb2NhbGVWYWx1ZXMuZW50cnlTZXQoKS5pdGVyYXRvcigpLm5leHQoKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBbKGNsYWltLmdldE5hbWUoKSArICIjIiArIGVudHJ5LmdldEtleSgpKTogZW50cnkuZ2V0VmFsdWUoKV0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVudHJ5ID0gbG9jYWxlVmFsdWVzLmVudHJ5U2V0KCkuaXRlcmF0b3IoKS5uZXh0KCkKICAgICAgICAgICAgICAgIHJldHVybiBbKGNsYWltLmdldE5hbWUoKSk6IGVudHJ5LmdldFZhbHVlKCldCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gWzpdCn0KCi8qCiAqIEdpdmVuIGEgc3RyaW5nICJlbnxFbmdsaXNoLGpwfEphcGVuZXNlLGZyX0NBfEZyZW5jaCBDYW5hZGlhbiIgd2lsbCByZXR1cm4gbWFwIG9mIGxvY2FsZSAtPiB2YWx1ZS4KICovCnBhcnNlTG9jYWxlQXdhcmVTdHJpbmcgPSB7IHMgLT4KICAgIHJldHVybiByZXN1bHQgPSBzLnNwbGl0KCIsIikuY29sbGVjdEVudHJpZXMgeyBlbnRyeSAtPgogICAgICAgIHNwbGl0ID0gZW50cnkuc3BsaXQoIlxcfCIpCiAgICAgICAgWyhzcGxpdFswXSk6IHZhbHVlID0gc3BsaXRbMV1dCiAgICB9Cn0KLy8gLS0tXl5eXl5eXl5eXi0tLSBFWEFNUExFIENMQUlNIEFUVFJJQlVURSBSRVNPTFZFUiBGVU5DVElPTlMgLS0tXl5eXl5eXl5eXi0tLQoKLy8gLS0tLS0tLS0tLS0tLS0gVVBEQVRFIFRISVMgVE8gQ0hBTkdFIENMQUlNIFRPIEFUVFJJQlVURSBNQVBQSU5HIEZVTkNUSU9OUyAtLS0tLS0tLS0tLS0tLS0KLyoKICogTGlzdCBvZiBjbGFpbSByZXNvbHZlciBtYXBwaW5ncy4KICovCi8vIFsge2NsYWltfToge2F0dHJpYnV0ZSByZXRyaWV2ZXJ9LCAuLi4gXQpjbGFpbUF0dHJpYnV0ZXMgPSBbCiAgICAgICAgImVtYWlsIjogdXNlclByb2ZpbGVDbGFpbVJlc29sdmVyLmN1cnJ5KCJtYWlsIiksCiAgICAgICAgImFkZHJlc3MiOiB7IGNsYWltLCBpZGVudGl0eSAtPiBbICJhZGRyZXNzIiA6IHVzZXJBZGRyZXNzQ2xhaW1SZXNvbHZlcihjbGFpbSwgaWRlbnRpdHkpIF0gfSwKICAgICAgICAicGhvbmVfbnVtYmVyIjogdXNlclByb2ZpbGVDbGFpbVJlc29sdmVyLmN1cnJ5KCJ0ZWxlcGhvbmVudW1iZXIiKSwKICAgICAgICAiZ2l2ZW5fbmFtZSI6IHVzZXJQcm9maWxlQ2xhaW1SZXNvbHZlci5jdXJyeSgiZ2l2ZW5uYW1lIiksCiAgICAgICAgInpvbmVpbmZvIjogdXNlclByb2ZpbGVDbGFpbVJlc29sdmVyLmN1cnJ5KCJwcmVmZXJyZWR0aW1lem9uZSIpLAogICAgICAgICJmYW1pbHlfbmFtZSI6IHVzZXJQcm9maWxlQ2xhaW1SZXNvbHZlci5jdXJyeSgic24iKSwKICAgICAgICAibG9jYWxlIjogdXNlclByb2ZpbGVDbGFpbVJlc29sdmVyLmN1cnJ5KCJwcmVmZXJyZWRsb2NhbGUiKSwKICAgICAgICAibmFtZSI6IHVzZXJQcm9maWxlQ2xhaW1SZXNvbHZlci5jdXJyeSgiY24iKQpdCgoKLy8gLS0tLS0tLS0tLS0tLS0gVVBEQVRFIFRISVMgVE8gQ0hBTkdFIFNDT1BFIFRPIENMQUlNIE1BUFBJTkdTIC0tLS0tLS0tLS0tLS0tCi8qCiAqIE1hcCBvZiBzY29wZXMgdG8gY2xhaW0gb2JqZWN0cy4KICovCi8vIHtzY29wZX06IFsge2NsYWltfSwgLi4uIF0Kc2NvcGVDbGFpbXNNYXAgPSBbCiAgICAgICAgImVtYWlsIjogWyAiZW1haWwiIF0sCiAgICAgICAgImFkZHJlc3MiOiBbICJhZGRyZXNzIiBdLAogICAgICAgICJwaG9uZSI6IFsgInBob25lX251bWJlciIgXSwKICAgICAgICAicHJvZmlsZSI6IFsgImdpdmVuX25hbWUiLCAiem9uZWluZm8iLCAiZmFtaWx5X25hbWUiLCAibG9jYWxlIiwgIm5hbWUiIF0KXQoKCi8vIC0tLS0tLS0tLS0tLS0tLS0gVVBEQVRFIEJFTE9XIEZPUiBBRFZBTkNFRCBVU0FHRVMgLS0tLS0tLS0tLS0tLS0tLS0tLQppZiAobG9nZ2VyLm1lc3NhZ2VFbmFibGVkKCkpIHsKICAgIHNjb3Blcy5maW5kQWxsIHsgcyAtPiAhKCJvcGVuaWQiLmVxdWFscyhzKSB8fCBzY29wZUNsYWltc01hcC5jb250YWluc0tleShzKSkgfS5lYWNoIHsgcyAtPgogICAgICAgIGxvZ2dlci5tZXNzYWdlKCJPcGVuQU1TY29wZVZhbGlkYXRvci5nZXRVc2VySW5mbygpOjpNZXNzYWdlOiBzY29wZSBub3QgYm91bmQgdG8gY2xhaW1zOiAkcyIpCiAgICB9Cn0KCi8qCiAqIENvbXB1dGVzIHRoZSBjbGFpbXMgcmV0dXJuIGtleSBhbmQgdmFsdWUuIFRoZSBrZXkgbWF5IGJlIGEgZGlmZmVyZW50IHZhbHVlIGlmIHRoZSBjbGFpbSB2YWx1ZSBpcyBub3QgaW4KICogdGhlIHJlcXVlc3RlZCBsYW5ndWFnZS4KICovCmRlZiBjb21wdXRlQ2xhaW0gPSB7IGNsYWltIC0+CiAgICB0cnkgewogICAgICAgIGNsYWltUmVzb2x2ZXIgPSBjbGFpbUF0dHJpYnV0ZXMuZ2V0KGNsYWltLmdldE5hbWUoKSwgeyBjbGFpbU9iaiwgaWRlbnRpdHkgLT4gZGVmYXVsdENsYWltUmVzb2x2ZXIoY2xhaW0pfSkKICAgICAgICBjbGFpbVJlc29sdmVyKGNsYWltLCBpZGVudGl0eSkKICAgIH0gY2F0Y2ggKElkUmVwb0V4Y2VwdGlvbiBlKSB7CiAgICAgICAgaWYgKGxvZ2dlci53YXJuaW5nRW5hYmxlZCgpKSB7CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJPcGVuQU1TY29wZVZhbGlkYXRvci5nZXRVc2VySW5mbygpOiBVbmFibGUgdG8gcmV0cmlldmUgYXR0cmlidXRlPSRhdHRyaWJ1dGUiLCBlKTsKICAgICAgICB9CiAgICB9IGNhdGNoIChTU09FeGNlcHRpb24gZSkgewogICAgICAgIGlmIChsb2dnZXIud2FybmluZ0VuYWJsZWQoKSkgewogICAgICAgICAgICBsb2dnZXIud2FybmluZygiT3BlbkFNU2NvcGVWYWxpZGF0b3IuZ2V0VXNlckluZm8oKTogVW5hYmxlIHRvIHJldHJpZXZlIGF0dHJpYnV0ZT0kYXR0cmlidXRlIiwgZSk7CiAgICAgICAgfQogICAgfQp9CgovKgogKiBDb252ZXJ0cyByZXF1ZXN0ZWQgc2NvcGVzIGludG8gY2xhaW0gb2JqZWN0cyBiYXNlZCBvbiB0aGUgc2NvcGUgbWFwcGluZ3MgaW4gc2NvcGVDbGFpbXNNYXAuCiAqLwpkZWYgY29udmVydFNjb3BlVG9DbGFpbXMgPSB7CiAgICBzY29wZXMuZmluZEFsbCB7IHNjb3BlIC0+ICJvcGVuaWQiICE9IHNjb3BlICYmIHNjb3BlQ2xhaW1zTWFwLmNvbnRhaW5zS2V5KHNjb3BlKSB9LmNvbGxlY3RNYW55IHsgc2NvcGUgLT4KICAgICAgICBzY29wZUNsYWltc01hcC5nZXQoc2NvcGUpLmNvbGxlY3QgeyBjbGFpbSAtPgogICAgICAgICAgICBuZXcgQ2xhaW0oY2xhaW0pCiAgICAgICAgfQogICAgfQp9CgovLyBDcmVhdGVzIGEgZnVsbCBsaXN0IG9mIGNsYWltcyB0byByZXNvbHZlIGZyb20gcmVxdWVzdGVkIHNjb3BlcywgY2xhaW1zIHByb3ZpZGVkIGJ5IEFTIGFuZCByZXF1ZXN0ZWQgY2xhaW1zCmRlZiBjbGFpbXNUb1Jlc29sdmUgPSBjb252ZXJ0U2NvcGVUb0NsYWltcygpICsgY2xhaW1PYmplY3RzICsgcmVxdWVzdGVkVHlwZWRDbGFpbXMKCi8vIENvbXB1dGVzIHRoZSBjbGFpbSByZXR1cm4ga2V5IGFuZCB2YWx1ZXMgZm9yIGFsbCByZXF1ZXN0ZWQgY2xhaW1zCmNvbXB1dGVkQ2xhaW1zID0gY2xhaW1zVG9SZXNvbHZlLmNvbGxlY3RFbnRyaWVzKCkgeyBjbGFpbSAtPgogICAgcmVzdWx0ID0gY29tcHV0ZUNsYWltKGNsYWltKQp9CgovLyBDb21wdXRlcyBjb21wb3NpdGUgc2NvcGVzCmRlZiBjb21wb3NpdGVTY29wZXMgPSBzY29wZUNsYWltc01hcC5maW5kQWxsIHsgc2NvcGUgLT4KICAgIHNjb3Blcy5jb250YWlucyhzY29wZS5rZXkpCn0KCnJldHVybiBuZXcgVXNlckluZm9DbGFpbXMoKE1hcCljb21wdXRlZENsYWltcywgKE1hcCljb21wb3NpdGVTY29wZXMp"
  }
}
